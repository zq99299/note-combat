<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>spring 开发中的实战 | 实战笔记</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/note-combat/favicon.ico">
    <link rel="manifest" href="/note-combat/manifest.json">
    <meta name="description" content="主要定位是在工作中实际遇到的难题、没有接触过、或稍有难度的真实场景解决记录">
    
    <link rel="preload" href="/note-combat/assets/css/0.styles.9121fd13.css" as="style"><link rel="preload" href="/note-combat/assets/js/app.1acf5fa8.js" as="script"><link rel="preload" href="/note-combat/assets/js/2.8f2b6977.js" as="script"><link rel="preload" href="/note-combat/assets/js/13.d18d9b62.js" as="script"><link rel="preload" href="/note-combat/assets/js/3.9baef331.js" as="script"><link rel="prefetch" href="/note-combat/assets/js/10.48a88567.js"><link rel="prefetch" href="/note-combat/assets/js/11.e50e7754.js"><link rel="prefetch" href="/note-combat/assets/js/12.e229e12c.js"><link rel="prefetch" href="/note-combat/assets/js/14.0d20196b.js"><link rel="prefetch" href="/note-combat/assets/js/4.1131d3d3.js"><link rel="prefetch" href="/note-combat/assets/js/5.19ecd13d.js"><link rel="prefetch" href="/note-combat/assets/js/6.4e165537.js"><link rel="prefetch" href="/note-combat/assets/js/7.19d2344a.js"><link rel="prefetch" href="/note-combat/assets/js/8.cfb618f8.js"><link rel="prefetch" href="/note-combat/assets/js/9.e150cb2a.js">
    <link rel="stylesheet" href="/note-combat/assets/css/0.styles.9121fd13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note-combat/" class="home-link router-link-active"><img src="mlogo.svg" alt="实战笔记" class="logo"> <span class="site-name can-hide">实战笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note-combat/spring/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Spring
</a></div><div class="nav-item"><a href="/note-combat/docker/" class="nav-link">
  Docker
</a></div><div class="nav-item"><a href="/note-combat/gitlab/" class="nav-link">
  GitLab
</a></div> <a href="https://github.com/zq99299/note-combat" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note-combat/spring/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Spring
</a></div><div class="nav-item"><a href="/note-combat/docker/" class="nav-link">
  Docker
</a></div><div class="nav-item"><a href="/note-combat/gitlab/" class="nav-link">
  GitLab
</a></div> <a href="https://github.com/zq99299/note-combat" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/note-combat/spring/" aria-current="page" class="active sidebar-link">spring 开发中的实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-combat/spring/#bootjar-部署到-k8s-中-启动传参数与配置文件" class="sidebar-link">bootJar 部署到 k8s 中，启动传参数与配置文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-combat/spring/#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#解决方案" class="sidebar-link">解决方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#日志变-json-格式输出" class="sidebar-link">日志变 JSON 格式输出</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-combat/spring/#背景-2" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#解决方案-2" class="sidebar-link">解决方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#升级程序自动执行相关数据库变更" class="sidebar-link">升级程序自动执行相关数据库变更</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-combat/spring/#背景-3" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#解决方案-3" class="sidebar-link">解决方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#spring-mvc-缓存控制-http-缓存" class="sidebar-link">Spring MVC 缓存控制(HTTP 缓存)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-combat/spring/#背景-4" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/note-combat/spring/#解决方案-4" class="sidebar-link">解决方案</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-开发中的实战"><a href="#spring-开发中的实战" class="header-anchor">#</a> spring 开发中的实战</h1> <h2 id="bootjar-部署到-k8s-中-启动传参数与配置文件"><a href="#bootjar-部署到-k8s-中-启动传参数与配置文件" class="header-anchor">#</a> bootJar 部署到 k8s 中，启动传参数与配置文件</h2> <h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p>在 boot 中，有一部分参数是只能写在  application.yml 中，写在 <code>application-xx.yml</code> 中，由于使用时机问题，有些配置属性就不生效了（比如：spring.profiles.active=prod）</p> <p>那么这一类首先想到解决方法是：在启动 jar 包的时候使用如下的形式传参</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup java -jar ${APP_JAR} --spring.profiles.active=${ACTIVE} --server.servlet.session.store-dir=${RESOURCES}/session-store-dir --logging.file.path=${RESOURCES}/logs &gt; /dev/null 2&gt;&amp;1 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到，传参变得很复杂，是个不小的挑战，</p> <h3 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>Spring boot 版本：2.4.1</p></blockquote> <p>那么我可以基于 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config" target="_blank" rel="noopener noreferrer">boot 的外部化配置文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中的 <strong>外部应用程序属性</strong>，将需要覆盖程序内的配置文件属性放到与 bootJar 同级的 <code>config</code> 目录下，如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>|- bootJar
|- config
	|- application.yml
	|- application-prod.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们将所有的配置属性都可以写到这个 application.yml 文件中，此时外部文件的属性优先级最高，会覆盖掉程序内部的配置文件属性</p> <h2 id="日志变-json-格式输出"><a href="#日志变-json-格式输出" class="header-anchor">#</a> 日志变 JSON 格式输出</h2> <h3 id="背景-2"><a href="#背景-2" class="header-anchor">#</a> 背景</h3> <p>放在 k8s 下，控制台输出的日志将被抽走，原来多行日志（特别是堆栈错误信息）会被解析成多行，而不是一行</p> <h3 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>Spring boot 版本：2.4.1</p></blockquote> <p>解决思路如下：</p> <ol><li>利用 logback 中的 <code>appender.encoder</code> 格式化控制台输出格式</li> <li>只在生产环境下生效：logback 配置文件只在生产环境下生效，该配置文件放在外部化配置文件目录中，通过外部化配置引用该配置文件</li></ol> <p>具体做法如下：</p> <ol><li><p>添加 <code>logstash-logback-encoder</code> 依赖，但是我们只使用它的 encoder 处理类</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 利用 logstash 打印 json 格式的 日志信息
implementation 'net.logstash.logback:logstash-logback-encoder:6.6'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>logback-spring.xml 配置文件，注意该配置文件只在生产环境下生效</p> <p>配置 consoleAppender ，在里面使用 LogstashEncoder 进行格式化日志信息</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org/springframework/boot/logging/logback/base.xml<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>consoleAppender<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>net.logstash.logback.encoder.LogstashEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>providers</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timestamp</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeZone</span><span class="token punctuation">&gt;</span></span>EST<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeZone</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timestamp</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>
                        {
                        &quot;level&quot;: &quot;%level&quot;,
                        &quot;service&quot;: &quot;orders&quot;,
                        &quot;traceId&quot;: &quot;%X{X-B3-TraceId:-}&quot;,
                        &quot;spanId&quot;: &quot;%X{X-B3-SpanId:-}&quot;,
                        &quot;thread&quot;: &quot;%thread&quot;,
                        &quot;class&quot;: &quot;%logger{40}&quot;,
                        &quot;message&quot;: &quot;%message&quot;
                        }
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stackTrace</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>throwableConverter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>net.logstash.logback.stacktrace.ShortenedThrowableConverter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxDepthPerThrowable</span><span class="token punctuation">&gt;</span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxDepthPerThrowable</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxLength</span><span class="token punctuation">&gt;</span></span>2048<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxLength</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shortenedClassNameLength</span><span class="token punctuation">&gt;</span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shortenedClassNameLength</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootCauseFirst</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootCauseFirst</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>throwableConverter</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stackTrace</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>providers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jsonLogger<span class="token punctuation">&quot;</span></span> <span class="token attr-name">additivity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>consoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>debug<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>consoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div></li> <li><p>在外部化配置文件中指向该配置文件</p> <p>我一般是和外部化文件放到一起，如下所示</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>|- bootJar
|- config
	|- application.yml
	|- logback-spring.xml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>application.yml 配置该文件</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> file<span class="token punctuation">:</span>/app/config/logback<span class="token punctuation">-</span>spring.xml
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">root</span><span class="token punctuation">:</span> info
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="升级程序自动执行相关数据库变更"><a href="#升级程序自动执行相关数据库变更" class="header-anchor">#</a> 升级程序自动执行相关数据库变更</h2> <h3 id="背景-3"><a href="#背景-3" class="header-anchor">#</a> 背景</h3> <p>对于数据库字段变更，数据库结构首次程序部署时的初始化，我们一般都是如下流程：</p> <ol><li>在生产环境下，找一台数据库</li> <li>手动创建数据库</li> <li>手动执行 SQL 脚本把表和初始数据创建好</li></ol> <p>在下次更新程序时的流程：</p> <ol><li>手动同步数据库表结构</li> <li>手动同步需要增加或则变更的数据</li></ol> <p>上面多次出现到了 <strong>手动</strong>，这个过程不难，但是繁琐且容易出错。 为了解决这个我们可以利用自动化来解决。</p> <h3 id="解决方案-3"><a href="#解决方案-3" class="header-anchor">#</a> 解决方案</h3> <blockquote><p>Spring boot 版本：2.4.1</p></blockquote> <p>Spring-boot 官方有一章是：<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-use-a-higher-level-database-migration-tool" target="_blank" rel="noopener noreferrer">使用更高级别的数据库迁移工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，自动配置中直接支持 <a href="https://flywaydb.org/" target="_blank" rel="noopener noreferrer">Flyway<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.liquibase.org/" target="_blank" rel="noopener noreferrer">Liquibase<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>这里我们使用 Flyway 来实现，官方也有他的 <a href="https://flywaydb.org/documentation/getstarted/how" target="_blank" rel="noopener noreferrer">工作原理和流程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，还有与 <a href="https://flywaydb.org/documentation/usage/plugins/springboot" target="_blank" rel="noopener noreferrer">spring boot 集成指引<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这里不细说。</p> <p>简单说一下：</p> <ol><li>flywa 会以版本号的方式在指定位置检测是否有 sql 脚本文件</li> <li>如果检测到有，则会执行该 sql 脚本文件</li> <li>执行完成后，会把该次执行的记录存放在 <em>flyway_schema_history</em> 表中</li> <li>下次程序启动，拿到 sql 脚本文件名中的版本号，与 <em>flyway_schema_history</em> 表中的记录进行对比，如果已经执行过则不再执行</li></ol> <p>那么这里就有如下的利用思路：</p> <ol><li><p>程序首次运行，初始化表结构和初始数据</p></li> <li><p>程序升级：执行表结构变更和数据变更脚本</p> <p>负载的数据变更，这里暂时不涉及到，官方说 flyway 还支持 java 代码编写迁移。</p></li></ol> <p>实际配置如下：</p> <ol><li><p>添加 flyway 依赖</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>    implementation <span class="token string">'org.flywaydb:flyway-core'</span>
    <span class="token comment">// 没有使用这个，纯粹为了解决启动报错：java.lang.NoClassDefFoundError: liquibase/exception/ChangeLogParseException</span>
    implementation <span class="token string">'org.liquibase:liquibase-core'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>自动配置参数：在 <code>application[-xx].yml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">flyway</span><span class="token punctuation">:</span>
    <span class="token comment"># 指定迁移脚本位置，这里放到 classpath 下的</span>
    <span class="token key atrule">locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>db/migration
    <span class="token comment"># 是否关闭这个功能：当表不为空时，是否清理数据库</span>
    <span class="token key atrule">clean-disabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">liquibase</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>在 <code>classpath:db/migration</code> 下准备你的数据迁移脚本</p> <p>V1__Initial_Setup.sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- 外键约束是否开启</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- 这里执行你的 sql 脚本</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>compound_task<span class="token punctuation">`</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ol> <p>其他配置属性，请参考官方的说明，这里简单讲解下它的迁移脚本命名方式：</p> <p>以 <code>V1__Initial_Setup.sql</code> 为例：</p> <ol><li><p><code>V1</code>  这个前缀的 <code>V</code> 是可以通过配置属性改变的，重要的是里面的数字</p> <p>它充当了版本的概念，每个版本只执行一次</p></li> <li><p><code>__</code> 后面的是你的描述，可以随意填写</p></li></ol></li></ol> <h2 id="spring-mvc-缓存控制-http-缓存"><a href="#spring-mvc-缓存控制-http-缓存" class="header-anchor">#</a> Spring MVC 缓存控制(HTTP 缓存)</h2> <p>使用 bootJar 内嵌启动的话，Spring MVC 也提供了一些缓存控制功能，<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-caching" target="_blank" rel="noopener noreferrer">官方比较详细<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>注意：你用 spring boot，但是里面 wen 层，用的是 Spring mvc ，那么就你要去找 Spring MVC 的官方文档，而不是 boot 的文档</p> <p>该文档中有：</p> <ul><li>Controllers：对 controller 提供缓存支持</li> <li>Static Resources：对静态资源提供缓存支持</li></ul> <p>这里讲解下如何对一个 Controller 提供 HTTP 缓存的支持</p> <h3 id="背景-4"><a href="#背景-4" class="header-anchor">#</a> 背景</h3> <p>提供了一个接口：根据 ID 查询一张图片，通过流的形式响应</p> <p>一般来说，这种接口无法触发浏览器的 缓存机制，但是通过如下方式可以做到</p> <h3 id="解决方案-4"><a href="#解决方案-4" class="header-anchor">#</a> 解决方案</h3> <p>没有缓存的写法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 图片读取
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/img/{tppFaceId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">img</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> tppFaceId<span class="token punctuation">,</span>
                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">TppFace</span> face <span class="token operator">=</span> faceService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>tppFaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>face <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;没有该资源&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> img <span class="token operator">=</span> face<span class="token punctuation">.</span><span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addDateHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Expires&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addDateHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Last-Modified&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cache-Control&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pathServiceProperties<span class="token punctuation">.</span><span class="token function">getWorkPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> contentType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tika</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token keyword">final</span> <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IoUtil</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>上述写了 缓存头，过期时间之类的，其实并不会生效。</p> <p>下面是生效的写法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/img/{tppFaceId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">img</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> tppFaceId<span class="token punctuation">,</span>
                    <span class="token class-name">WebRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 在本场景中，图片生成之后，就永远不会改变，这里的版本号我就写死成 1 了</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> eTag <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里检查该请求携带过来的 eTag 版本号，如果与我们这里的一致，就直接返回</span>
        <span class="token comment">// 返回时: 框架帮我们做了重要的一件事件，更改了响应状态码为 304</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">checkNotModified</span><span class="token punctuation">(</span>eTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">TppFace</span> face <span class="token operator">=</span> faceService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>tppFaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>face <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;没有该资源&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> img <span class="token operator">=</span> face<span class="token punctuation">.</span><span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addDateHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Last-Modified&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 利用缓存配置构建设置头  max-age 的时间等信息</span>
        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>CACHE_CONTROL<span class="token punctuation">,</span> <span class="token class-name">CacheControl</span><span class="token punctuation">.</span><span class="token function">maxAge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>DAYS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaderValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 该 id 首次响应的时候，添加响应头，版本也写  1</span>
        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;eTag&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pathServiceProperties<span class="token punctuation">.</span><span class="token function">getWorkPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> contentType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tika</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token keyword">final</span> <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IoUtil</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zq99299/note-combat/edit/main/docs/spring/README.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-03-08 10:13:12</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/note-combat/assets/js/app.1acf5fa8.js" defer></script><script src="/note-combat/assets/js/2.8f2b6977.js" defer></script><script src="/note-combat/assets/js/13.d18d9b62.js" defer></script><script src="/note-combat/assets/js/3.9baef331.js" defer></script>
  </body>
</html>
